<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insights - FinMate</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/components.css">
  <link rel="stylesheet" href="../css/insights.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="insights-container">
    <!-- Header -->
    <header class="header">
      <div class="header-container">
        <div class="header-left">
          <button id="navbar-toggle" class="navbar-toggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="logo">
            <img src="../assets/images/logo.svg" alt="FinMate Logo">
            <span class="logo-text">FinMate</span>
          </div>
        </div>
        <div class="header-right">
          <div class="profile-dropdown">
            <button id="profile-toggle" class="profile-toggle">
              <i class="fas fa-user"></i>
            </button>
            <div class="profile-menu" id="profile-menu">
              <div class="profile-menu-header">
                <div class="profile-menu-name" id="profile-name">User Name</div>
                <div class="profile-menu-email" id="profile-email">user@example.com</div>
              </div>
              <ul class="profile-menu-items">
                <li class="profile-menu-item">
                  <a href="dashboard.html" class="profile-menu-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                  </a>
                </li>
                <li class="profile-menu-item">
                  <a href="profile.html" class="profile-menu-link">
                    <i class="fas fa-user"></i>
                    Profile
                  </a>
                </li>
                <li class="profile-menu-divider"></li>
                <li class="profile-menu-item">
                  <a href="#" id="logout-btn" class="profile-menu-link logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="insights-content">
      <!-- Side Navigation -->
      <nav class="sidenav" id="sidenav">
        <ul class="sidenav-menu">
          <li class="sidenav-item">
            <a href="dashboard.html" class="sidenav-link">
              <i class="fas fa-tachometer-alt"></i>
              Dashboard
            </a>
          </li>
          <li class="sidenav-item">
            <a href="transactions.html" class="sidenav-link">
              <i class="fas fa-exchange-alt"></i>
              Transactions
            </a>
          </li>
          <li class="sidenav-item">
            <a href="insights.html" class="sidenav-link active">
              <i class="fas fa-chart-bar"></i>
              Insights
            </a>
          </li>
          <li class="sidenav-item">
            <a href="budgeting.html" class="sidenav-link">
              <i class="fas fa-bullseye"></i>
              Budgeting
            </a>
          </li>
          <li class="sidenav-item">
            <a href="profile.html" class="sidenav-link">
              <i class="fas fa-user"></i>
              Profile
            </a>
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="insights-main">
        <div class="insights-header">
          <h2>Financial Insights</h2>
        </div>

        <!-- Filters Section -->
        <div class="insights-filters">
          <div class="filter-group">
            <label for="date-from-filter">From Date</label>
            <input type="date" id="date-from-filter">
          </div>
          <div class="filter-group">
            <label for="date-to-filter">To Date</label>
            <input type="date" id="date-to-filter">
          </div>
          <div class="filter-group">
            <label for="type-filter">Type</label>
            <select id="type-filter">
              <option value="">All</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>
          <div class="filter-buttons">
            <button id="apply-filters-btn" class="apply-filters-btn">Apply Filters</button>
            <button id="reset-filters-btn" class="reset-filters-btn">Reset</button>
          </div>
        </div>

        <!-- Empty Insights State -->
        <div class="empty-insights" id="empty-insights" style="display: none;">
          <i class="fas fa-chart-pie"></i>
          <h3>No Data Available</h3>
          <p>Add transactions to generate insights and visualizations</p>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid" id="charts-grid">
          <!-- Pie Chart - Expenses by Category -->
          <div class="chart-container">
            <div class="chart-header">
              <h3 class="chart-title">Expenses by Category</h3>
              <p class="chart-description">Distribution of your expenses across different categories</p>
            </div>
            <div class="chart-canvas-container">
              <canvas id="pie-chart"></canvas>
            </div>
          </div>

          <!-- Bar Chart - Income vs Expense -->
          <div class="chart-container">
            <div class="chart-header">
              <h3 class="chart-title">Income vs Expense</h3>
              <p class="chart-description">Monthly comparison of your income and expenses</p>
            </div>
            <div class="chart-canvas-container">
              <canvas id="bar-chart"></canvas>
            </div>
          </div>

          <!-- Line Chart - Balance Trend -->
          <div class="chart-container full-width">
            <div class="chart-header">
              <h3 class="chart-title">Balance Trend</h3>
              <p class="chart-description">Your balance trend over time showing monthly and cumulative changes</p>
            </div>
            <div class="chart-canvas-container">
              <canvas id="line-chart"></canvas>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loading-spinner" style="display: none;">
    <div class="spinner"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Load Firebase Config and Utils -->
  <script src="../js/firebase-config.js"></script>
  <script src="../js/utils.js"></script>
  
  <!-- Insights Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const dateFromFilter = document.getElementById('date-from-filter');
      const dateToFilter = document.getElementById('date-to-filter');
      const typeFilter = document.getElementById('type-filter');
      const applyFiltersBtn = document.getElementById('apply-filters-btn');
      const resetFiltersBtn = document.getElementById('reset-filters-btn');
      const emptyInsights = document.getElementById('empty-insights');
      const chartsGrid = document.getElementById('charts-grid');
      const pieChartCanvas = document.getElementById('pie-chart');
      const barChartCanvas = document.getElementById('bar-chart');
      const lineChartCanvas = document.getElementById('line-chart');
      
      // Initialize sidebar and profile dropdown
      initializeSidebar();
      initializeProfileDropdown();
      
      // Chart instances
      let pieChart = null;
      let barChart = null;
      let lineChart = null;
      
      // Current user data
      let currentUser = null;
      
      // Check if user is logged in
      firebase.auth().onAuthStateChanged(async function(user) {
        if (user) {
          // User is logged in
          currentUser = user;
          
          // Load insights data
          loadInsightsData();
        } else {
          // User is not logged in, redirect to login page
          window.location.href = 'login.html';
        }
      });
      
      // Apply filters button
      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', function() {
          loadInsightsData();
        });
      }
      
      // Reset filters button
      if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', function() {
          if (dateFromFilter) dateFromFilter.value = '';
          if (dateToFilter) dateToFilter.value = '';
          if (typeFilter) typeFilter.value = '';
          
          loadInsightsData();
        });
      }
      
      // Load insights data
      async function loadInsightsData() {
        if (!currentUser) return;
        showLoading(true);
        try {
          // Get transactions
          const transactionsRef = firebase.firestore().collection('users').doc(currentUser.uid).collection('transactions');
          let query = transactionsRef.orderBy('date', 'desc');
          if (typeFilter && typeFilter.value) {
            query = query.where('type', '==', typeFilter.value);
          }
          const transactionsSnapshot = await query.get();
          let transactions = [];
          transactionsSnapshot.forEach(doc => {
            transactions.push({ id: doc.id, ...doc.data() });
          });
          // Apply date filters client-side
          if (dateFromFilter && dateFromFilter.value) {
            const fromDate = new Date(dateFromFilter.value);
            fromDate.setHours(0, 0, 0, 0);
            transactions = transactions.filter(transaction => {
              const transactionDate = new Date(transaction.date);
              return transactionDate >= fromDate;
            });
          }
          if (dateToFilter && dateToFilter.value) {
            const toDate = new Date(dateToFilter.value);
            toDate.setHours(23, 59, 59, 999);
            transactions = transactions.filter(transaction => {
              const transactionDate = new Date(transaction.date);
              return transactionDate <= toDate;
            });
          }
          // Fetch profile income
          let baseIncome = 0;
          let incomeType = "monthly";
          const metaDoc = await firebase.firestore().collection('users').doc(currentUser.uid).collection('meta').doc('profile').get();
          if (metaDoc.exists) {
            const metaData = metaDoc.data();
            if (metaData.income) {
              baseIncome = parseFloat(metaData.income.amount) || 0;
              incomeType = metaData.income.type || "monthly";
            }
          }
          // Show/hide empty state
          if (transactions.length === 0 && baseIncome === 0) {
            if (emptyInsights) emptyInsights.style.display = 'flex';
            if (chartsGrid) chartsGrid.style.display = 'none';
          } else {
            if (emptyInsights) emptyInsights.style.display = 'none';
            if (chartsGrid) chartsGrid.style.display = 'grid';
            // Create charts (pass baseIncome and incomeType)
            createPieChart(transactions);
            createBarChart(transactions, baseIncome, incomeType);
            createLineChart(transactions, baseIncome, incomeType);
          }
          showLoading(false);
        } catch (error) {
          console.error('Error loading insights data:', error);
          showToast('Error loading insights data. Please try again.', 'error');
          showLoading(false);
        }
      }
      
      // Create pie chart for expenses by category
      function createPieChart(transactions) {
        if (!pieChartCanvas) return;
        // Destroy existing chart if any
        if (pieChart) {
          pieChart.destroy();
        }
        // Filter expenses only
        const expenses = transactions.filter(transaction => transaction.type === 'expense');
        if (expenses.length === 0) {
          return;
        }
        // Prepare data for chart
        const categoryData = {};
        expenses.forEach(transaction => {
          if (!categoryData[transaction.category]) {
            categoryData[transaction.category] = 0;
          }
          categoryData[transaction.category] += parseFloat(transaction.amount);
        });
        const labels = Object.keys(categoryData);
        const data = Object.values(categoryData);
        // Generate colors for chart
        const colors = generateChartColors(labels.length);
        // Create chart
        pieChart = new Chart(pieChartCanvas, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              },
              title: {
                display: true,
                text: 'Expenses by Category'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed;
                    return `${context.label}: ${formatCurrency(value)}`;
                  }
                }
              }
            }
          }
        });
      }
      
      // Create bar chart for income vs expense by month
      function createBarChart(transactions, baseIncome = 0, incomeType = "monthly") {
        if (!barChartCanvas) return;
        if (barChart) { barChart.destroy(); }
        if (transactions.length === 0 && baseIncome === 0) { return; }
        // Group transactions by month
        const monthlyData = {};
        transactions.forEach(transaction => {
          const date = new Date(transaction.date);
          const month = date.toLocaleString('default', { month: 'short', year: 'numeric' });
          if (!monthlyData[month]) {
            monthlyData[month] = { income: 0, expense: 0 };
          }
          if (transaction.type === 'income') {
            monthlyData[month].income += parseFloat(transaction.amount);
          } else {
            monthlyData[month].expense += parseFloat(transaction.amount);
          }
        });
        // If baseIncome is set, add to each month (for monthly income)
        if (baseIncome > 0) {
          let months = Object.keys(monthlyData);
          if (months.length === 0) {
            // If no transactions, show at least current month
            const now = new Date();
            const thisMonth = now.toLocaleString('default', { month: 'short', year: 'numeric' });
            months = [thisMonth];
            monthlyData[thisMonth] = { income: 0, expense: 0 };
          }
          months.forEach(month => {
            if (incomeType === "monthly") {
              monthlyData[month].income += baseIncome;
            } else if (incomeType === "one-time") {
              // Add one-time income only to the earliest month
              const sortedMonths = months.slice().sort((a, b) => new Date(a) - new Date(b));
              if (month === sortedMonths[0]) {
                monthlyData[month].income += baseIncome;
              }
            }
          });
        }
        // Sort months chronologically
        const sortedMonths = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b));
        const incomeData = sortedMonths.map(month => monthlyData[month].income);
        const expenseData = sortedMonths.map(month => monthlyData[month].expense);
        barChart = new Chart(barChartCanvas, {
          type: 'bar',
          data: {
            labels: sortedMonths,
            datasets: [
              {
                label: 'Income',
                data: incomeData,
                backgroundColor: '#4CAF50',
                borderWidth: 1
              },
              {
                label: 'Expense',
                data: expenseData,
                backgroundColor: '#F44336',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: false },
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) { return formatCurrency(value); }
                }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Monthly Income vs Expense'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    return `${context.dataset.label}: ${formatCurrency(value)}`;
                  }
                }
              }
            }
          }
        });
      }
      
      // Create line chart for monthly balance trend
      function createLineChart(transactions, baseIncome = 0, incomeType = "monthly") {
        if (!lineChartCanvas) return;
        if (lineChart) { lineChart.destroy(); }
        if (transactions.length === 0 && baseIncome === 0) { return; }
        // Group transactions by month
        const monthlyData = {};
        transactions.forEach(transaction => {
          const date = new Date(transaction.date);
          const month = date.toLocaleString('default', { month: 'short', year: 'numeric' });
          if (!monthlyData[month]) {
            monthlyData[month] = { income: 0, expense: 0 };
          }
          if (transaction.type === 'income') {
            monthlyData[month].income += parseFloat(transaction.amount);
          } else {
            monthlyData[month].expense += parseFloat(transaction.amount);
          }
        });
        // Add base income to each month (if monthly income)
        if (baseIncome > 0) {
          let months = Object.keys(monthlyData);
          if (months.length === 0) {
            // If no transactions, show at least current month
            const now = new Date();
            const thisMonth = now.toLocaleString('default', { month: 'short', year: 'numeric' });
            months = [thisMonth];
            monthlyData[thisMonth] = { income: 0, expense: 0 };
          }
          months.forEach(month => {
            if (incomeType === "monthly") {
              monthlyData[month].income += baseIncome;
            } else if (incomeType === "one-time") {
              // Add one-time income only to the earliest month
              const sortedMonths = months.slice().sort((a, b) => new Date(a) - new Date(b));
              if (month === sortedMonths[0]) {
                monthlyData[month].income += baseIncome;
              }
            }
          });
        }
        // Sort months chronologically
        const sortedMonths = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b));
        // Calculate monthly balance
        const balanceData = sortedMonths.map(month => {
          return monthlyData[month].income - monthlyData[month].expense;
        });
        // Calculate cumulative balance
        let cumulativeBalance = 0;
        const cumulativeData = balanceData.map(balance => {
          cumulativeBalance += balance;
          return cumulativeBalance;
        });
        lineChart = new Chart(lineChartCanvas, {
          type: 'line',
          data: {
            labels: sortedMonths,
            datasets: [
              {
                label: 'Monthly Balance',
                data: balanceData,
                backgroundColor: 'rgba(0, 188, 212, 0.2)',
                borderColor: '#00bcd4',
                borderWidth: 2,
                tension: 0.4,
                fill: false
              },
              {
                label: 'Cumulative Balance',
                data: cumulativeData,
                backgroundColor: 'rgba(179, 136, 255, 0.2)',
                borderColor: '#b388ff',
                borderWidth: 2,
                tension: 0.4,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                ticks: {
                  callback: function(value) { return formatCurrency(value); }
                }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Monthly Balance Trend'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    return `${context.dataset.label}: ${formatCurrency(value)}`;
                  }
                }
              }
            }
          }
        });
      }
    });
  </script>
</body>
</html>